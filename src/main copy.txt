#include <MD_Parola.h>
#include <MD_MAX72xx.h>
#include <SPI.h>

// Define the hardware type and connections
#define HARDWARE_TYPE MD_MAX72XX::FC16_HW
#define MAX_DEVICES 4 // Number of 8x8 modules in the chain

#define DATA_PIN 4 // DIN pin
#define CS_PIN 2   // CS pin
#define CLK_PIN 15 // CLK pin
#define VCC 17
#define GND 16

// Create the matrix object
MD_Parola matrix_parola = MD_Parola(HARDWARE_TYPE, DATA_PIN, CLK_PIN, CS_PIN, MAX_DEVICES);
MD_MAX72XX matrix = MD_MAX72XX(HARDWARE_TYPE, DATA_PIN, CLK_PIN, CS_PIN, MAX_DEVICES);

int playerY = 0 + 7;   // Y-coordinate of the player (row)
int player2Y = 31 - 7; // Y-coordinate of Player 2
int rectrow[4] = {2, 3, 4, 5};
int linep1 = 6;
int linep2 = 25;
int linerow[8] = {0, 1, 2, 3, 4, 5, 6, 7};
int score1 = 0;
int score2 = 0;


// Segment map for digits in the "tens" position (rows 0-2)
const int tensDigitMap[10][11][2] = {
    // Digit 0
    {{0, 0}, {1, 0}, {2, 0}, {2, 1}, {2, 2}, {1, 2}, {0, 2}, {-1, -1}, {-1, -1}, {-1, -1}, {-1, -1}},
    // Digit 1
    {{0, 1}, {1, 1}, {2, 1}, {-1, -1}, {-1, -1}, {-1, -1}, {-1, -1}, {-1, -1}, {-1, -1}, {-1, -1}, {-1, -1}},
    // Digit 2 (Updated for tens position)
    {{0, 0}, {1, 0}, {2, 0}, {2, 1}, {2, 2}, {1, 2}, {0, 2}, {0, 3}, {0, 4}, {1, 4}, {2, 4}},
    // ... Remaining digits
};

const int unitsDigitMap[10][15][2] = {
    // Digit 0 (3x5 size)
    {{5, 0}, {5, 1}, {5, 2}, {5, 3}, {5, 4}, // Top horizontal line
     {6, 0},
     {6, 4}, // Left and right vertical lines
     {7, 0},
     {7, 1},
     {7, 2},
     {7, 3},
     {7, 4}, // Bottom horizontal line
     {-1, -1},
     {-1, -1},
     {-1, -1}}, // Padding for unused segments

    // Digit 1
    {{5, 1}, {6, 1}, {7, 1}, // Vertical line
     {-1, -1},
     {-1, -1},
     {-1, -1},
     {-1, -1},
     {-1, -1},
     {-1, -1},
     {-1, -1},
     {-1, -1},
     {-1, -1},
     {-1, -1},
     {-1, -1},
     {-1, -1}},

    // Digit 2
    {{5, 0}, {5, 1}, {5, 2}, {5, 3}, {5, 4}, // Top horizontal line
     {6, 4},                                 // Right vertical line
     {7, 0},
     {7, 1},
     {7, 2},
     {7, 3},
     {7, 4}, // Bottom horizontal line
     {6, 0}, // Left vertical line
     {-1, -1},
     {-1, -1},
     {-1, -1}},
    // Add remaining digits here...
};

void displayTensDigitLeft(MD_MAX72XX *matrix, int digit)
{
  if (digit < 0 || digit > 9)
    return; // Invalid digit

  for (int segment = 0; segment < 11; segment++)
  {
    int row = tensDigitMap[digit][segment][0];
    int col = tensDigitMap[digit][segment][1];

    if (row != -1 && col != -1)
    { // Valid segment
      matrix->setPoint(row, col, true);
    }
  }
}

void displayUnitsDigitLeft(MD_MAX72XX *matrix, int digit)
{
  if (digit < 0 || digit > 9)
    return; // Invalid digit

  for (int segment = 0; segment < 15; segment++)
  {
    int row = unitsDigitMap[digit][segment][0];
    int col = unitsDigitMap[digit][segment][1];

    if (row != -1 && col != -1)
    { // Valid segment
      matrix->setPoint(row, col, true);
    }
  }
}

void displayTensDigitRight(MD_MAX72XX *matrix, int digit)
{
  if (digit < 0 || digit > 9)
    return; // Invalid digit

  for (int segment = 0; segment < 11; segment++)
  {
    int row = 7 - tensDigitMap[digit][segment][0];  // Flip vertically
    int col = 31 - tensDigitMap[digit][segment][1]; // Flip horizontally

    if (row != -1 && col != -1)
    { // Valid segment
      matrix->setPoint(row, col, true);
    }
  }
}

void displayUnitsDigitRight(MD_MAX72XX *matrix, int digit)
{
  if (digit < 0 || digit > 9)
    return; // Invalid digit

  for (int segment = 0; segment < 15; segment++)
  {
    int row = 7 - unitsDigitMap[digit][segment][0];  // Flip vertically
    int col = 31 - unitsDigitMap[digit][segment][1]; // Flip horizontally

    if (row != -1 && col != -1)
    { // Valid segment
      matrix->setPoint(row, col, true);
    }
  }
}

// Score
void displayLeftScore(MD_MAX72XX *matrix, int score)
{
  if (score < 0 || score > 30)
    return; // Invalid score

  if (score >= 0 && score <= 9)
  {
    // Display score as a single-digit (use the tens position)
    displayTensDigitLeft(matrix, score);
  }
  else if (score >= 10 && score <= 30)
  {
    // Split the score into tens and units
    int tens = score / 10;
    int units = score % 10;

    // Display tens and units in their respective positions
    displayTensDigitLeft(matrix, tens);
    displayUnitsDigitLeft(matrix, units);
  }
}

void displayRightScore(MD_MAX72XX *matrix, int score)
{
  if (score < 0 || score > 30)
    return; // Invalid score

  if (score >= 0 && score <= 9)
  {
    // Display score as a single-digit (use the tens position)
    displayTensDigitRight(matrix, score);
  }
  else if (score >= 10 && score <= 30)
  {
    // Split the score into tens and units
    int tens = score / 10;
    int units = score % 10;

    // Display tens and units in their respective positions
    displayTensDigitRight(matrix, tens);
    displayUnitsDigitRight(matrix, units);
  }
}
void testDots()
{
  for (uint8_t device = 0; device < MAX_DEVICES; device++)
  {
    for (uint8_t row = 0; row < 8 * 4; row++)
    {
      for (uint8_t col = 0; col < 8 * 4; col++)
      {
        matrix.setPoint(row, col, true); // Turn on each dot for each device
      }
    }
  }
  delay(2000);
  matrix.clear();
}

void drawLine(MD_MAX72XX *matrix, int linerow[], int linep1, int linep2)
{
  for (int i = 0; i < 8; i++)
  {
    matrix->setPoint(linerow[i], linep1, true);
    matrix->setPoint(linerow[i], linep2, true);
  }
}

void setup()
{
  Serial.begin(9600);
  pinMode(VCC, OUTPUT);
  digitalWrite(VCC, HIGH);
  pinMode(GND, OUTPUT);
  digitalWrite(GND, LOW);
  matrix_parola.begin(); // Initialize the parola
  // testDots();
  matrix_parola.setIntensity(5);
  // matrix_parola.displayText("5024221021 - Agus Fuad Mudhofar", PA_CENTER, 100, 100, PA_SCROLL_LEFT, PA_SCROLL_LEFT);

  MD_MAX72XX *matrix = matrix_parola.getGraphicObject(); // Get the graphics object
  // setPoint(row, col, true?); column 0 - 31, row 0 - 7
  // Draw rectangle 1 (column 0+7)
  for (int i = 0; i < 4; i++)
  {
    matrix->setPoint(rectrow[i], playerY, true); // Turn on each dot
  }

  // Draw rectangle 2 (column 31-7)
  for (int i = 0; i < 4; i++)
  {
    matrix->setPoint(rectrow[i], player2Y, true);
  }

  drawLine(matrix, linerow, linep1, linep2);
  // displayTensDigitLeft(matrix, 2);  // Tens digit (rows 0-2)
  // displayUnitsDigitLeft(matrix, 0); // Units digit (rows 5-7)

}

void loop()
{
  MD_MAX72XX *matrix = matrix_parola.getGraphicObject();

  for (int i = 0; i < 3; i++)
  {
    displayTensDigitLeft(matrix, i); // Tens digit (rows 0-2)
    Serial.println("Display Tens Digit Left : " + String(i));
    delay(1000);
    matrix->clear();
    displayUnitsDigitLeft(matrix, i); // Units digit (rows 5-7)
    Serial.println("Display Units Digit Left : " + String(i));
    delay(1000);
    matrix->clear();
    displayTensDigitRight(matrix, i); // Tens digit (rows 0-2)
    Serial.println("Display Tens Digit Right : " + String(i));
    delay(1000);
    matrix->clear();
    displayUnitsDigitRight(matrix, i); // Units digit (rows 5-7)
    Serial.println("Display Units Digit Right : " + String(i));
    delay(1000);
    matrix->clear();
  }
  // matrix->clear();
  // delay(2000); // Keep the LED off for 1 second
}
